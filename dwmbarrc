#!/bin/bash

# Example file, designed to be edited.

DELAY=0.05
MODULES_DIR="/home/$USER/.config/dwmbar/modules/"
CUSTOM_DIR="/home/$USER/.config/dwmbar/modules/custom/"
SEPARATOR=" | "
PADDING="$USER@$HOSTNAME "

OUTPUT_CACHE="/home/$USER/.config/dwmbar/.cache/"
OUTPUT=""

# What modules, in what order
MODULES="mpd weather volumebar wifi internet cpuload temperature battery date time"

# Modules that require an active internet connection
ONLINE_MODULES="weather internet"

INTERNET=1 #0 being true

get_internet()
{
    curl -q http://google.com &> /dev/null

    if [[ $? -eq 0 ]]; then
        INTERNET=0
    else
        INTERNET=1
    fi
}

get_bar()
{
	for module in $MODULES; do
		if [[ $INTERNET -eq 0 ]] || [[ $ONLINE_MODULES != *"$module"* ]];then
			module_out=$(cat $OUTPUT_CACHE$module | sed 's/\.$//g')
			bar=$bar$module_out
		fi
	done
	# Uncomment to remove last separator
	# bar=$(echo $bar | sed 's/.$//g')
	echo "$bar$PADDING"
}

run_module()
{
	if [[ -f "$CUSTOM_DIR$1" ]]
	then
		out="$(exec $CUSTOM_DIR$1)"
	else
		out="$(exec $MODULES_DIR$1)"
	fi

	[[ ! "$out" = "" ]] && [[ ! "$module" = "NULL" ]] && out="$out$SEPARATOR."
	echo $out > "$OUTPUT_CACHE$module"
}

run()
{
    get_internet
	for module in $MODULES; do
		if [[ $INTERNET -eq 0 ]]; then
			run_module $module
		else
			[[ $ONLINE_MODULES != *"$module"* ]] && run_module $module
		fi
	done
	get_bar
	sleep $DELAY;
}

run
